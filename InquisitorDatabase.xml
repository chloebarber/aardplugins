<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Tuesday, March 25, 2025, 7:36 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Inquisitor" generated by Plugin Wizard -->

<muclient>
<plugin
   name="InquisitorDatabase"
   author="Bartoc"
   id="a0df32eada26b5a8bdec0c87"
   language="Lua"
   purpose="Builds a mob database using Interrogate"
   save_state="y"
   date_written="2025-03-25 19:35:24"
   requires="5.07"
   version="1.0"
   >

</plugin>


<!--  Variables  -->

<variables>
</variables>

<!--  Script  -->


<script>
<![CDATA[

mob = {
uniqid = "", 
name = "", 
room = "", 
zone = "", 
level = 0, 
guild = "", 
subclass = "", 
alignment = "", 
bash = 0.0, 
pierce = 0.0, 
slash = 0.0, 
acid = 0.0, 
air = 0.0, 
cold = 0.0, 
disease = 0.0, 
earth = 0.0, 
energy = 0.0, 
fire = 0.0, 
holy = 0.0, 
light = 0.0, 
electric = 0.0, 
magic = 0.0, 
mental = 0.0, 
negative = 0.0, 
poison = 0.0, 
shadow = 0.0, 
sonic = 0.0, 
water = 0.0, 
bash = 0.0
}

function OnPluginInstall()
  GenTable()
end

function GenTable()
  DatabaseOpen("db", GetInfo(66) .. "inquisitor.sqlite", 6)
  Note("Opened DB")
  DatabaseExec ("db", [[
    DROP TABLE IF EXISTS mobs;
    CREATE TABLE mobs(
        uniqid TEXT NOT NULL PRIMARY KEY,
        name      TEXT NOT NULL,
        room      TEXT NOT NULL,
        zone      TEXT NOT NULL,
        level     INT NOT NULL
        guild      TEXT NOT NULL,
        subclass      TEXT NOT NULL,
        alignment   TEXT NOT NULL,
        bash    REAL,
        pierce    REAL,
        slash    REAL,
        acid    REAL,
        air    REAL,
        cold    REAL,
        disease    REAL,
        earth    REAL,
        energy    REAL,
        fire    REAL,
        holy    REAL,
        light    REAL,
        electric     REAL,
        magic    REAL,
        mental    REAL,
        negative    REAL,
        poison    REAL,
        shadow    REAL,
        sonic    REAL,
        water    REAL
      );
      ]])
  DatabaseClose("db")
  Note("Closed DB")
end

function InterrogationSuccessful()
  mob = {}
  EnableTriggerGroup("capture_entry", true)
  mob.Zone = "currentzone"
  mob.Room = "currentroom"
  Note("Interrogation successful.")
end

function Capture(flag, data)
  mob[flag] = data
end

function CaptureResist(name, data)
  sorted = {}
  --we're just capturing these separately to build an easily sorted list
  --ordering resists on capture reduces complexity of weakpoint analysis on run I think
  Capture(flag, data)
  Capture("ResistanceList", sorted)
end

function ParseAlignment(flavortext)
  alignvalue = ""
  -- map flavor text to alignment range
  Capture("Alignment", alignvalue)
end

function PostEntry()
  -- convert the table to a SQL entry and insert
  EnableTriggerGroup("capture_entry", false)
  Note("Mob info captured.")
end

function CheckIfCatalogued(name)
  --check if name + room + zone exists
  catalogued = "false" -- make this the lookup instead
  if catalogued == false then
    iq = 0 --enable alias to interrogate
  end
end

function HeaderDisable()
  EnableTrigger("header", false)
end

]]>
</script>

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   group="start_inquisitor"
   match="As you mercilessly interrogate *, you learn ..."
   omit_from_output="y"
   sequence="100"
  >
  <send>InterrogateSuccessful()</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   name="header"
   match="----------------------------------------------------------------"
   omit_from_output="y"
   sequence="100"
  >
  <send>HeaderDisable()</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   match="Mob Short Name   : (*)"
   omit_from_output="y"
   sequence="100"
  >
  <send>Capture("Name", "%1")</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   match="Mob Base Level   : (*)"
   omit_from_output="y"
   sequence="100"
  >
  <send>Capture("Level", "%1")</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   match="Guild            : (*)"
   omit_from_output="y"
   sequence="100"
  >
  <send>Capture("Guild", "%1")</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   match="Subclass         : (*)"
   omit_from_output="y"
   sequence="100"
  >
  <send>Capture("Subclass", "%1")</send>
  </trigger>
    <trigger
   enabled="n"
   group="capture_entry"
   match="Alignment        : (*)"
   omit_from_output="y"
   sequence="100"
  >
  <send>ParseAlignment("1%")</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   match="Note             : (*)"
   omit_from_output="y"
   sequence="100"
  >
  </trigger> -- we're just throwing away the notes, they're too general to be useful
  <trigger
   enabled="n"
   group="capture_entry"
   match="------------------------- [ Resistances ] ----------------------"
   omit_from_output="y"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   match="([^\s]+)[\s:]+([0-9\-\.]+)%"
   omit_from_output="y"
   keep_evaluating="y"
   sequence="100"
  > -- may need to check syntax on keep evaluating or if it's appropriate
  <send>CaptureResist("%1", "%2")</send>
  </trigger>
  <trigger
   enabled="n"
   group="capture_entry"
   name="footer"
   match="----------------------------------------------------------------"
   omit_from_output="y"
   sequence="101"
  >
  <send>PostEntry()</send>
  </trigger>
</triggers>

</muclient>

