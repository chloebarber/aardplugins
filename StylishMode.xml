<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, March 22, 2025, 11:13 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "SmartFighter" generated by Plugin Wizard -->

<muclient>
<plugin
   name="StylishMode"
   author="Bartoc"
   id="4464d1277385ca0637b8cdc3"
   language="Lua"
   purpose="happy"
   save_state="y"
   date_written="2025-03-22 23:12:35"
   requires="5.07"
   version="1.0"
   >

</plugin>

<aliases>
   <alias
      match="^(north|south|east|west|up|down)$"
      enabled="y"
      regexp="y"
      send_to="12"
      sequence="20"
   >
      <send>LastDir("%1")</send>
   </alias>
</aliases>


<!--  Triggers  -->

<triggers>
   <trigger
   enabled="n"
   group="skills_capture"
   match="Skill\/Spell name            Level  Sn   %"
   omit_from_output="y"
   regexp="y"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="skills_capture"
   match="--------------------------  -----  --- ---"
   omit_from_output="y"
   regexp="y"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="skills_capture"
   match="^\s(([,'\-\w]\s?)+)(?<!\s)"
   omit_from_output="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>CaptureSkill("%1")</send>
  </trigger>
  <trigger
   enabled="n"
   group="skills_capture"
   match="\* means that you cannot use the skill\/spell\."
   omit_from_output="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>CaptureComplete()</send>
  </trigger>
  <trigger
   match="gold coins from the [\w\s]* corpse"
   script="ClearOnDeath"
   enabled="y"
   regexp="y"
   sequence="20"
  >
  </trigger>
  <trigger
   match="^The (door|trapdoor|gate) is closed."
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="20"
  >
  <send>DoorBuddy()</send>
  </trigger>
  <trigger
   match="^You do not have a key for the (door|trapdoor|gate)."
   script="DoorBuddyKnock"
   enabled="y"
   regexp="y"
   sequence="20"
  >
  </trigger>
  <trigger
   match="^You (open|unlock) the (door|trapdoor|gate)."
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="20"
  >
  <send>WalkThroughDoor()</send>
  </trigger>
</triggers>

<!--  Aliases  -->

<!--  Timers  -->

<timers>

  <timer name="gcd" second="2.50" offset_second="0.00"    send_to="12"
group="stylish_mode" >
  <send>RunStylishMode()</send>
  </timer>

    <timer name="ogcd" second="23" offset_second="0.00"    send_to="12"
group="stylish_mode" >
  <send>OGCD()</send>
  </timer>

</timers>

<!--  Variables  -->

<variables>
  <variable name="drink_container"></variable>
</variables>


<!--  Script  -->


<script>
<![CDATA[
require "aard_register_z_on_create"

require "mw_theme_base"
require "serialize"
require "movewindow"
require "commas"
require "gmcphelper"
require "copytable"

page_built = false
gmcp_char = {}
skill_list = {}
cached_delay = 0 -- save old speedwalk delay if slowing it down

drink_container = "Decanter of Endless Water"

current_level = 0
function OnPluginInstall()
   Note("Stylish Mode installed.")
   Send_GMCP_Packet("request status")
end

function PopulateSkills() -- capture all learned skills up to your current level
   skill_list = {}
   EnableTriggerGroup("skills_capture", true)
   SendNoEcho("allspells 1 ".. current_level .. " learned")
end

function CaptureSkill(skill)
   skill = string.lower(skill)
   skill_list[skill] = true
end

function CaptureComplete()
   EnableTriggerGroup("skills_capture", false)
end

function UseSkill(skill) -- if you have the requested skill: use it and return true; otherwise false
   if skill_list[skill] then
      Send("cast " .. "\"" .. skill .. "\"")
      return true
   else
      return false
   end
end



function RunStylishMode() 
  FBfighting = gmcp_char.status.enemy
  if FBfighting ~= "" then
   -- AutoPotion()
   ResetTimer("gcd")



    enemypct = ReturnPercent("enemyhp")
    if enemypct <= 15 and enemypct > 0 and UseSkill("terminate") then
    elseif enemypct >= 30 then
       if Debuffs() then 
       elseif UseSkill("pillar of fire") then end
    end
   else
      EnableTimer("gcd", false)
   end
end

soften = false
ego_whip = false
psychic_drain = true
raw_flesh = false
tortured_vision = false
function Debuffs()
   if not ego_whip and UseSkill("ego whip") then
      ego_whip = true
      return true
   elseif not soften and UseSkill("soften") then
      soften = true
      return true
   elseif not raw_flesh and UseSkill("raw flesh") then
      raw_flesh = true
      return true
   elseif not psychic_drain and UseSkill("psychic drain") then
      psychic_drain = true
      return true
   else
      return false
   end
end

function ResetDebuffs()
   soften = false
   ego_whip = false
   psychic_drain = false
end

function AutoPotion() -- add a potion check before enabling
   if ReturnPercent("mana") < 15 then
      send("drink lotus")
   end
   if ReturnPercent("hp") < 15 then
      send("drink heal")
   end
end

function AutoDrink()
   if tonumber(gmcp_char.status.hunger) < 50 or tonumber(gmcp_char.status.thirst) < 50 then
      Send("gulp " .. drink_container)
   end
end

function ReturnPercent(stat)
   if stat == "hp" then
      return tonumber(gmcp_char.vitals.hp)/tonumber(gmcp_char.maxstats.maxhp)
   elseif stat == "hp" then
      return tonumber(gmcp_char.vitals.mana)/tonumber(gmcp_char.maxstats.maxmana)
   elseif stat == "enemyhp" then
      return tonumber(gmcp_char.status.enemypct)
   else
      Note("Bad percentage detected!" .. stat)
      return 100
   end
end

function OGCD() 
  FBfighting = gmcp_char.status.enemy
  if FBfighting ~= "" then
   ResetTimer("OGCD")
    enemypct = tonumber(gmcp_char.status.enemypct)
    Send("flay")
   else
      EnableTimer("OGCD", false)
   end
end

function ClearOnDeath()
   ResetDebuffs()
end

function OnPluginBroadcast (msg, id, name, text)

   -- Look for GMCP handler.
   if (id == '3e7dedbe37e44942dd46d264') then
      if (text == 'reload') then
         -- invalidate current data
         page_built = false
         return
      end

      if (text == "char.base" or text == "char.vitals" or text == "char.status" or text == "char.maxstats") then
         if text == "char.base" then
            gmcp_char.base = gmcp("char.base")
         elseif text == "char.vitals" then
            gmcp_char.vitals = gmcp("char.vitals")
         elseif text == "char.status" then
            gmcp_char.status = gmcp("char.status")
         else
            gmcp_char.maxstats = gmcp("char.maxstats")
         end
         if gmcp_char.status then
            if tonumber(gmcp("char.status.level")) > tonumber(current_level) then
                  current_level = gmcp("char.status.level")
                  PopulateSkills()
            end
            page_built = true
            --AutoDrink()
            --EnableTimer("ogcd", true)
            EnableTimer("gcd", true)
         end
      end
   end
end

last_direction = "north"
function DoorBuddy()
   Send("open " .. last_direction)
end

function DoorBuddyKnock()
   Send("cast knock " .. last_direction)
end

function LastDir(direction)
   last_direction = direction
   Send(direction)
end

function WalkThroughDoor()
   Send(last_direction)
end

function SuperiorSpellup() -- spellup which intelligently uses int/wis buffs first
end

castTable = {
   scourge = "Your scourge",
   flay = {"Your whipping", "## You may now use Whipmaster abilities."},
   terminate = "Your deadly force"
}

failcast = "lost your concentration"

]]>
</script>

</muclient>
